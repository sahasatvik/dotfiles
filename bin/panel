#!/usr/bin/bash

PANEL_FIFO=/tmp/panel-fifo
PANEL_FONT="Fira Code Nerd Font-10"
PANEL_HEIGHT=24

if [ $(pgrep -cx panel) -gt 1 ] ; then
        printf "%s\n" "The panel is already running." >&2
        exit 1
fi

trap 'bspc config top_padding 0; trap - TERM; kill 0' INT TERM QUIT EXIT

[ -e "$PANEL_FIFO" ] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"


bspc config top_padding $PANEL_HEIGHT

bspc subscribe > "$PANEL_FIFO" &

while true; do
        echo "C" $(date +"%T")
        sleep 1
done > "$PANEL_FIFO" &

while true; do
        echo "D" $(date "+%a %d %b")
        echo "B" $(cat /sys/class/power_supply/BAT0/capacity)
        echo "MEM" $(free -m | grep Mem | awk '{print $3}')
        
        sleep 5
done > "$PANEL_FIFO" &

while true; do
        netstatus="$(iwconfig wlp2s0)"
        
        essid="$(echo $netstatus | grep -oe 'ESSID:[^ ]*')"
        essid="${essid#ESSID:}"

        if [[ "$essid" =~ "off" ]]; then
                echo "N off"
        else
                quality="$(echo $netstatus | grep -oe "Link Quality=[^ ]*/[^ ]*")"
                quality=${quality#Link Quality=}
                numerator="${quality%/*}"
                denominator="${quality#*/}"
                percent="$(($numerator * 100 / $denominator))"

                echo "N" $percent $essid
        fi
        
        newmail="$(fd . ~/.mail/*/INBOX/new/ --type f | wc -l)"
        echo "MAIL" $newmail

        sleep 10
done > "$PANEL_FIFO" &

cmusstat="$(cmus-remote -C status | grep status | sed 's/status //g')"
echo M$cmusstat > "$PANEL_FIFO" &

cat "$PANEL_FIFO" | ~/bin/panel_bar | lemonbar -F "#DDDDDD" -B "#1D1F21" -f "$PANEL_FONT" -g x$PANEL_HEIGHT -a 24 | sh &

until bar_id=$(xdo id -n lemonbar); do sleep 0.001; done
xdo above -t $(xdo id -n root) $bar_id


wait
